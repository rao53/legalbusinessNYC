# Results

```{r}
library(tidyverse)
library(patchwork)
library(Lock5withR)
library(ggplot2)
library(vcd)
library(dplyr)
library(plotly)
library(viridis)
library(forcats)
library(ggridges)
library(parcoords)

library(RColorBrewer)
library(tidyr)
library(tibble)
library(hrbrthemes)
library(plotly)
```


## Total licences across industries
```{r,fig.width = 8,fig.height = 8}
df_nyc_data = read_csv("./Legally_Operating_Businesses.csv")
df_nyc_data$date_diff = as.Date(df_nyc_data$`License Expiration Date`, format="%m/%d/%Y")-as.Date(df_nyc_data$`License Creation Date`, format="%m/%d/%Y")
df_nyc_data$date_diff<-as.numeric(df_nyc_data$date_diff)
df_nyc_data_clean_dates = filter(df_nyc_data,df_nyc_data$date_diff > 0)
df_nyc_data_clean = select(df_nyc_data_clean_dates,-c("Secondary Address Street Name","Detail","Business Name 2"))
df_nyc_data_clean_borough = filter(df_nyc_data_clean,!df_nyc_data_clean$`Address Borough` %in% c("BRONX","QUEENS","BROOKLYN","MANHATTAN", "Outside NYC"))

Total_Count_Across_Industries = df_nyc_data_clean_borough %>%
  group_by(Industry) %>%
  count() %>%
  ungroup() %>%
  ggplot(aes(n, reorder(Industry, n))) +
  geom_point() +
  theme_linedraw() +
  xlab("Count") +
  ylab("Industry")

Total_Count_Across_Industries
```
We can see that the home improvement and tobacco industry attains the maximum number of licenses and forms a cluster of their own.

## Popularity of businesses across boroughs
```{r,fig.width = 8,fig.height = 8}
# Part 1
borough_license_count <- df_nyc_data_clean_borough %>%
  group_by(Industry, `Address Borough`) %>%
  summarize(count = n()) %>%
  ungroup()

borough_license_count = borough_license_count %>% drop_na()

Licence_Count_Across_Boroughs = ggplot(borough_license_count, aes(x = count, y = reorder(Industry, count), color = `Address Borough`)) +
  geom_point() +
  theme_linedraw() +
  theme(legend.position = "top") + 
  ylab("Industry")
Licence_Count_Across_Boroughs
```


```{r,fig.width = 8,fig.height = 8}
top10Industries <- df_nyc_data_clean_borough %>%
  drop_na(`Address Borough`) %>% 
  group_by(Industry) %>%
  summarize(n = n()) %>%
  slice_max(order_by = n, n = 10) %>%
  pull(Industry)

df_nyc_data_clean_borough_droppedNA = df_nyc_data_clean_borough %>%
  drop_na(`Address Borough`) %>% 
  group_by(Industry, `Address Borough`) %>%
  summarize(count = n()) %>%
  ungroup() %>%
  filter(Industry %in% top10Industries)

ggplot(df_nyc_data_clean_borough_droppedNA, aes(fill=`Address Borough`, y=count, x=reorder(Industry, -count))) +
  geom_bar(position="dodge", stat="identity") +
  xlab("Industry") +
  coord_flip()
```
Write - Up



## Licence count across industries based on status/type
```{r,fig.width = 8,fig.height = 8}
license_status_count <- df_nyc_data_clean_borough %>%
  group_by(Industry, `License Status`) %>%
  summarize(count = n()) %>%
  ungroup()

license_status_count = license_status_count %>% drop_na()

total_license_status <- license_status_count %>%
  group_by(Industry) %>%
  summarize(count = sum(count)) %>%
  mutate(`License Status` = "Total")

combine_lsc_tls <- bind_rows(license_status_count, total_license_status) %>%
  mutate(Industry = fct_reorder2(Industry, `License Status` == "Total", -count))

Licence_Count_based_status = ggplot(combine_lsc_tls, aes(x = count, y = reorder(Industry, count), color = `License Status`)) +
  geom_point() +
  theme_linedraw() +
  theme(legend.position = "top") +
  ylab("Industry")
Licence_Count_based_status
```
Also on looking at the split across active and inactive licenses we can see that most of the licenses for home improvement contractors and tobacco retail dealers have expired. There is no split between active and inactive licenses for home improvement Salesperson and that is because all of these licenses have expired and are inactive (which we can infer from the heat maps shown below split by License Status). 

Most of the industries have more inactive licenses than active licenses. But there are a few exceptions like Laundries and Electronic Cigarette Dealerships where we have more active licenses than inactive licenses. 

```{r,fig.width = 8,fig.height = 8}

license_type_count <- df_nyc_data_clean_borough %>%
  group_by(Industry, `License Type`) %>%
  summarize(count = n()) %>%
  ungroup()

license_type_count = license_type_count %>% drop_na()

Licence_Count_based_type = ggplot(license_type_count, aes(x = count, y = reorder(Industry, count), color = `License Type`)) +
  geom_segment(aes(yend=Industry), xend = 0) +
  geom_point() +
  theme_linedraw() +
  theme(legend.position = "top") +
  ylab("Industry") +
  facet_grid(`License Type` ~ ., scales = "free_y", space = "free_y")

Licence_Count_based_type
```
Looking at the split between license types we see that there are no industries with both License type Individual and Business. Most of the industries have license type Business, only a few Industries like Locksmith, projectionist, home improvement salesperson, general vendors etc. have been issued licenses of individual type.



## Total licences across industries over 20 years
```{r,fig.width = 8,fig.height = 10}
df_nyc_data_clean_borough$creation_year = format(as.Date(df_nyc_data_clean_borough$`License Creation Date`, format="%d/%m/%Y"),"%Y")

Industry_creationyear_count <- df_nyc_data_clean_borough %>%
  group_by(Industry, creation_year) %>%
  summarize(count = n()) %>%
  ungroup()

theme_heat <- theme_classic() +
  theme(axis.line = element_blank(), axis.ticks = element_blank())

Industry_creation_year_count = Industry_creationyear_count %>% drop_na(creation_year) %>%
  filter(creation_year > 1999)

Total_license_creation_year = ggplot(Industry_creation_year_count, aes(creation_year, Industry)) +
  geom_tile(aes(fill = count)) +
  theme_ipsum() +
  scale_fill_distiller(palette = "Spectral", direction=2, trans = "log10", 
                       name = "log10(licence count)") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))  +
  xlab("Licence creation year") 

ggplotly(Total_license_creation_year)
```
We can clearly see that the tobacco retail dealer licenses have gradually decreased over the last 20 years.
The electronic cigarette dealership licenses did not exist before 2018 as these dealerships were legally given licenses in 2018. We can see the sudden increase in the number of licenses in 2018 and how it drastically drops as a lot of studies showed how teenagers were getting addicted to vapes and eventually in July of 2020 they were banned in the city of New York.


```{r,fig.width = 8,fig.height = 10}
Industry_creation_year_status_count <- df_nyc_data_clean_borough %>%
  group_by(Industry, creation_year, `License Status`) %>%
  summarize(count = n()) %>%
  ungroup()

Industry_creation_year_status_count = Industry_creation_year_status_count %>% drop_na(creation_year) %>%
  filter(creation_year > 1999)
Industry_license_creation_year_status_count = ggplot(Industry_creation_year_status_count, aes(creation_year, Industry)) +
  geom_tile(aes(fill = count)) +
  scale_fill_distiller(palette = "Spectral", direction=2, trans = "log10", 
                       name = "log10(licence count)") +
  facet_wrap(~`License Status`) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  xlab("Licence creation year") 

ggplotly(Industry_license_creation_year_status_count)
```
For the heatmap split between active and inactive licenses we can clearly see that Industries like Ticket Seller Businesses, Sightseeing Bus, Motion Picture Projectionist, Catering Establishments, Cabaret etc. have no active licenses. And this makes sense because all these industries have been heavily affected by covid.


```{r,fig.width = 8,fig.height = 10}
Industry_creation_year_type_count <- df_nyc_data_clean_borough %>%
  group_by(Industry, creation_year, `License Type`) %>%
  summarize(count = n()) %>%
  ungroup()

Industry_creation_year_type_count_bu = Industry_creation_year_type_count %>% drop_na(creation_year) %>%
  filter(creation_year > 1999 & `License Type` == "Business") 

Industry_creation_year_type_count_pe = Industry_creation_year_type_count %>% drop_na(creation_year) %>%
  filter(creation_year > 1999 & `License Type` != "Business") 

Industry_license_creation_year_type_count1 = ggplot(Industry_creation_year_type_count_bu, aes(creation_year, Industry)) +
  geom_tile(aes(fill = count)) +
  scale_fill_distiller(palette = "Spectral", direction=2, trans = "log10", 
                       name = "log10(licence count)") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))  +
  ggtitle("Industry vs Creation_Year based on Business licence type") +
  xlab("Licence creation year") 

ggplotly(Industry_license_creation_year_type_count1)
```

```{r,fig.width = 8,fig.height = 4}
Industry_license_creation_year_type_count2 = ggplot(Industry_creation_year_type_count_pe, aes(creation_year, Industry)) +
  geom_tile(aes(fill = count)) +
  scale_fill_distiller(palette = "Spectral", direction=2, trans = "log10", 
                       name = "log10(licence count)") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  ggtitle("Industry vs Creation_Year based on Individual licence type") +
  xlab("Licence creation year") 

ggplotly(Industry_license_creation_year_type_count2)
```
Write-Up


## Licence application acceptance rate across borough over 10 years
```{r,fig.width = 8,fig.height = 8}
df_nyc_data_applications = read_csv("./dataset_applications.csv")
df_nyc_data_applications_grouped = df_nyc_data_applications %>%
  group_by(Decision.Date,nyc.data.borough, Status) %>%
  summarize(count = n()) %>%
  ungroup()

df_nyc_data_applications_grouped = df_nyc_data_applications_grouped %>% 
  filter(Decision.Date > 2009) %>%
  drop_na("Decision.Date") %>% 
  pivot_wider(names_from = Status, values_from = count)

df_nyc_data_applications_grouped = replace(df_nyc_data_applications_grouped,is.na(df_nyc_data_applications_grouped),0)
df_nyc_data_applications_grouped = df_nyc_data_applications_grouped %>%
  mutate(total = Issued + Denied) %>%
  mutate(prop = Issued / total)

ggplot(df_nyc_data_applications_grouped, aes(x = Decision.Date, y = prop)) + 
  geom_line(aes(color = nyc.data.borough)) +
  xlab("Decision date") +
  ylab("Acceptance rate")
```
Write-Up stuff


## Duration of licences in days for various industries
```{r,fig.width = 8,fig.height = 8}
ridge_plot_dateDiff = ggplot(df_nyc_data_clean_dates, aes(date_diff, fct_reorder(Industry, date_diff))) +
  geom_density_ridges(fill = "red", alpha = .3) +
  xlab("length of licences (Days)") +
  ylab("Industry")
ridge_plot_dateDiff
```
Write-Up



